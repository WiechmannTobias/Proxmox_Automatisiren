#!/bin/bash

echo "Starte Bereinigung und Deinstallation von WireGuard..."

# Sicherstellen, dass das Skript als root ausgeführt wird
if [ "$(id -u)" -ne 0 ]; then
  echo "Dieses Skript muss als root ausgeführt werden!"
  exit 1
fi

# Definiere die Standard-IP, das Interface und den DNS
DEFAULT_IP="192.168.40.19"
DEFAULT_INTERFACE=""
DEFAULT_DNS="1.1.1.1"

# Das Interface für die Standard-IP herausfinden
DEFAULT_INTERFACE=$(ip -o addr show | grep "$DEFAULT_IP" | awk '{print $2}')

if [ -z "$DEFAULT_INTERFACE" ]; then
  echo "Fehler: Keine Schnittstelle mit der IP $DEFAULT_IP gefunden!"
  exit 1
fi

echo "Behalte IP $DEFAULT_IP auf Interface $DEFAULT_INTERFACE."

# Alle anderen IP-Adressen von Netzwerkinterfaces entfernen
echo "Entferne alle anderen IP-Adressen von Netzwerkinterfaces..."
for interface in $(ls /sys/class/net); do
  if [ "$interface" != "$DEFAULT_INTERFACE" ]; then
    ip addr flush dev "$interface"
  else
    echo "Behalte Konfiguration für $interface."
  fi
done

# Routing-Tabelle zurücksetzen, aber sicherstellen, dass DEFAULT_IP korrekt geroutet wird
echo "Setze Routing-Tabelle zurück und stelle Standard-Gateway sicher..."
ip route flush table main
ip route add default via "$DEFAULT_IP" dev "$DEFAULT_INTERFACE" table main

# DNS-Server setzen
echo "Setze DNS-Server auf $DEFAULT_DNS..."
if [ -f /etc/resolv.conf ]; then
  echo "nameserver $DEFAULT_DNS" > /etc/resolv.conf
else
  echo "Fehler: /etc/resolv.conf konnte nicht geschrieben werden!"
fi

# ARP-Tabelle leeren
echo "Leere ARP-Tabelle..."
ip neigh flush all

# WireGuard-Interfaces herunterfahren
echo "Stoppe WireGuard-Interfaces..."
wg-quick down wg0 2>/dev/null
systemctl stop wg-quick@wg0 2>/dev/null

# WireGuard-Pakete deinstallieren
echo "Deinstalliere WireGuard-Pakete..."
if command -v apt >/dev/null; then
  apt purge -y wireguard wireguard-tools
  apt autoremove -y
elif command -v dnf >/dev/null; then
  dnf remove -y wireguard-tools
elif command -v yum >/dev/null; then
 
