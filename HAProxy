job "haproxy" {
  datacenters = ["dc1"]

  group "load-balancer" {
    count = 1  # Nur eine Instanz des Load Balancers

    task "haproxy" {
      driver = "docker"

      config {
        image = "haproxy:latest"
        ports = ["http"]
        command = "/usr/local/sbin/haproxy"
        args = [
          "-f", "/etc/haproxy/haproxy.cfg"
        ]
      }

      template {
        data = <<EOF
global
  log /dev/log    local0
  log /dev/log    local1 notice
  maxconn 2000
  user haproxy
  group haproxy
  daemon

defaults
  log     global
  option  httplog
  timeout connect 5000ms
  timeout client  50000ms
  timeout server  50000ms

frontend http_front
  bind *:80  # Hören auf Port 80
  default_backend http_back

backend http_back
  balance roundrobin  # Load Balancing
  server web1 webserver1:8080 check  # Webserver 1
  server web2 webserver2:8080 check  # Webserver 2
  server web3 webserver3:8080 check  # Webserver 3
EOF
        destination = "/etc/haproxy/haproxy.cfg"
      }

      resources {
        cpu    = 100
        memory = 128
        network {
          port "http" {
            static = 80  # Port 80 für HTTP
          }
        }
      }

      service {
        name = "haproxy"
        port = "http"

        check {
          type     = "http"
          path     = "/"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
